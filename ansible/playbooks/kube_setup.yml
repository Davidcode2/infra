---
# Play 1: Wait for servers to be ready for SSH
- name: Prepare all nodes
  hosts: all
  gather_facts: False
  tasks:
    - name: Wait for SSH to be available
      ansible.builtin.wait_for_connection:
        timeout: 60

# Play 2: Install the k3s cluster
- name: Install k3s HA cluster
  hosts: k3s_masters
  become: true
  roles:
    - k3s-ha

# Play 3: Fetch kubeconfig for local use
- name: Fetch kubeconfig
  hosts: k3s_master_init
  become: true
  tasks:
    - name: Fetch k3s.yaml from the first master
      ansible.builtin.fetch:
        src: /etc/rancher/k3s/k3s.yaml
        dest: "kubeconfig-{{ k3s_init_node_ip }}.yaml"
        flat: yes

    - name: Replace localhost with First Node IP in local kubeconfig
      local_action:
        module: ansible.builtin.replace
        path: "kubeconfig-{{ k3s_init_node_ip }}.yaml"
        regexp: '127\.0\.0\.1'
        replace: '{{ k3s_init_node_ip }}'
      run_once: true
      become: false
