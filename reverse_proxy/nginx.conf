events {}

http {
  limit_req_zone $binary_remote_addr zone=mylimit:5m rate=15r/s;

  # TLS hardening
  ssl_protocols TLSv1.2 TLSv1.3;
  ssl_prefer_server_ciphers on;
  ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
  ssl_session_cache shared:SSL:10m;
  ssl_session_timeout 10m;

  server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name admin.schluesselmomente-freiburg.de www.admin.schluesselmomente-freiburg.de;
  
    ssl_certificate /etc/letsencrypt/live/legit-certificate/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/legit-certificate/privkey.pem;
  
    location / {
        limit_req zone=mylimit burst=30 nodelay;
        proxy_pass http://schluesselmomente-cms:1337;
    }
  }

  server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name schluesselmomente-freiburg.de www.schluesselmomente-freiburg.de;
  
    ssl_certificate /etc/letsencrypt/live/legit-certificate/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/legit-certificate/privkey.pem;
  
    location / {
        limit_req zone=mylimit burst=30 nodelay;
        proxy_pass http://schluesselmomente_nginx_proxy:80;
    }
  }

  server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name blog.jakob-lingel.dev www.blog.jakob-lingel.dev;
  
    ssl_certificate /etc/letsencrypt/live/legit-certificate/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/legit-certificate/privkey.pem;
  
    location / {
        limit_req zone=mylimit burst=30 nodelay;
        proxy_pass http://blog:80;
    }
  }

  server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name immoly.jakob-lingel.dev www.immoly.jakob-lingl.dev;
  
    ssl_certificate /etc/letsencrypt/live/legit-certificate/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/legit-certificate/privkey.pem;
  
    return 301 https://immoly.io$request_uri;
  }

  server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name immoly.io www.immoly.io;
  
    ssl_certificate /etc/letsencrypt/live/legit-certificate/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/legit-certificate/privkey.pem;
  
    location / {
        limit_req zone=mylimit burst=30 nodelay;
        proxy_pass http://immoly-app:3000;

        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
  }

  server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name mimis-kreativstudio.de www.mimis-kreativstudio.de;
  
    ssl_certificate /etc/letsencrypt/live/legit-certificate/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/legit-certificate/privkey.pem;
  
    location / {
        limit_req zone=mylimit burst=30 nodelay;
        proxy_pass http://mimis-kreativstudio-ghost:2368;

        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
  }

  server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name alemazung.jakob-lingel.dev www.alemazung.jakob-lingel.dev;
  
    ssl_certificate /etc/letsencrypt/live/legit-certificate/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/legit-certificate/privkey.pem;
  
    location / {
        limit_req zone=mylimit burst=30 nodelay;
        proxy_pass http://joy-alemazung-ghost:2368;

        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
  }

  server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name analytics.jakob-lingel.dev www.analytics.jakob-lingel.dev;
  
    ssl_certificate /etc/letsencrypt/live/legit-certificate/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/legit-certificate/privkey.pem;
  
    location / {
        limit_req zone=mylimit burst=30 nodelay;
        proxy_pass http://umami:3000;

        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
  }
}
